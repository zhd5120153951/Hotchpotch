<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- <link rel="icon" type="image/jpg" href="favicon.png" />  -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo</title>
    <!-- 请勿在项目正式环境中引用该 layui.css 地址 -->
    <link href="../static/layui/css/layui.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/style.css">
</head>

<body>
    <div class="layui-container">
        <div id="sourcesNode"></div>
        <button onclick="setPlayerSource('rtsp://127.0.0.1')">搜索通道</button>
        <div>
            <input id="stream_url" value="rtsp://<camera ip or url>" size="36">
            <button id="set_new_url">设置</button>
            <div class="custom-control custom-switch">
                <input type="checkbox" id="continuous_recording">
                <label for="customSwitch1">持续录制</label>
            </div>
        </div>
        <div>
            <p style="color:#808080">Enter your rtsp link to the stream, for example: "rtsp://192.168.1.1:554/h264"</p>
        </div>
        <div>
            <span style="color:#808080">Change video file length of the continuous recording</span>
            <input id="continuous_file_length" type="range" min="10000" max="200000" value="180000" step="1000"
                style="width:40%;">
            <p id="continuous_file_length_label">180sec.</p>
        </div>
        <div>
            <span style="color:#808080">Change buffer duration</span>
            <input id="buffer_duration" type="range" min="10" max="200" style="width:40%;">
            <p id="buffer_value">120sec.</p>
        </div>
        <canvas id="video_canvas" resize="true"></canvas>
        <video id="test_video" controls autoplay></video>

        <div class="controls form">
            <div>
                Playback rate:&nbsp;
                <input id="rate" class="input" type="range" min="0.5" max="5.0" value="1.0" step="0.5">
                <output for="rate" id="rate_res">live</output>
            </div>
            <div>
                <button id="to_end" class="btn btn-success" disabled>live</button>
                <button id="event_recording" class="btn btn-success" disabled>开始录制</button>
            </div>
        </div>
        <div>
            <span style="color:#808080">Select a recorded file to playback</span>
            <input id="file_input" type="file" accept=".mp4">
        </div>

        <div id="pllogs" class="logs"></div>
        <button class="btn btn-success" onclick="cleanLog(pllogs)">clear</button>
        <button class="btn btn-success" onclick="scrollset(pllogs, true)">scroll up</button>
        <button class="btn btn-success" onclick="scrollset(pllogs, false)">scroll down</button>
        <button id="scrollSetPl" class="btn btn-success" onclick="scrollswitch(pllogs)">Scroll off</button>
        <button class="btn btn-success" onclick="statisticRequest('GET_INFO')">Get statistic</button>
        <button class="btn btn-success" onclick="statisticRequest('SUBSCRIBE')">Subscribe statistic</button>
        <br /><br />

        <form class="layui-form" action>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">得分阈值:</label>
                    <div class="layui-input-inline layui-input-wrap">
                        <input type="text" name="scoreTh" lay-verify="required" autocomplete="off" lay-reqtext="请输入阈值"
                            lay-affix="clear" class="layui-input">
                    </div>
                    <div class="layui-form-mid" style="padding: 0!important;">

                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">IOU阈值:</label>
                <div class="layui-input-inline layui-input-wrap">
                    <input type="text" name="iouTh" lay-verify="required" autocomplete="off" lay-affix="clear"
                        class="layui-input">
                </div>
            </div>

            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注:</label>
                <div class="layui-input-block" style="width: 320px;">
                    <textarea placeholder="请输入内容" class="layui-textarea"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn" lay-submit lay-filter="submit">提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>

    <!-- 请勿在项目正式环境中引用该 layui.js 地址 -->
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/libde265.js"></script>
    <script src="../static/js/free.player.3.3.js"></script>

    <script>
        var scrollStatPl = true;
        var scrollStatWs = true;
        var pllogs = document.getElementById("pllogs");
        var wslogs = document.getElementById("wslogs");

        // define a new console
        var console = (function (oldConsole) {
            return {
                log: function () {
                    oldConsole.log(newConsole(arguments, "black", "#A9F5A9"));
                },
                info: function () {
                    oldConsole.info(newConsole(arguments, "black", "#A9F5A9"));
                },
                warn: function () {
                    oldConsole.warn(newConsole(arguments, "black", "#F3F781"));
                },
                error: function () {
                    oldConsole.error(newConsole(arguments, "black", "#F5A9A9"));
                }
            };
        }(window.console));

        function newConsole(args, textColor, backColor) {
            let text = '';
            let node = document.createElement("div");
            for (let arg in args) {
                text += ' ' + args[arg];
            }
            node.appendChild(document.createTextNode(text));
            node.style.color = textColor;
            node.style.backgroundColor = backColor;
            pllogs.appendChild(node);
            autoscroll(pllogs);
            return text;
        }

        //Then redefine the old console
        window.console = console;

        function cleanLog(element) {
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
        }

        function autoscroll(element) {
            if (scrollStatus(element)) {
                element.scrollTop = element.scrollHeight;
            }
            if (element.childElementCount > 1000) {
                element.removeChild(element.firstChild);
            }
        }

        function scrollset(element, state) {
            if (state) {
                element.scrollTop = 0;
                scrollChange(element, false);
            } else {
                element.scrollTop = element.scrollHeight;
                scrollChange(element, true);
            }
        }

        function scrollswitch(element) {
            if (scrollStatus(element)) {
                scrollChange(element, false);
            } else {
                scrollChange(element, true);
            }
        }

        function scrollChange(element, status) {
            if (scrollStatus(element)) {
                scrollStatPl = false;
                document.getElementById("scrollSetPl").innerText = "Scroll on";
            } else {
                scrollStatPl = true;
                document.getElementById("scrollSetPl").innerText = "Scroll off";
            }
        }

        function scrollStatus(element) {
            if (element.id === "pllogs") {
                return scrollStatPl;
            } else {
                return scrollStatWs;
            }
        }


    </script>

    <script>
        if (window.Streamedian) {
            let errHandler = function (err) {
                alert(err.message);
            };

            let infHandler = function (inf) {
                let sourcesNode = document.getElementById("sourcesNode");
                let clients = inf.clients;
                sourcesNode.innerHTML = "";

                for (let client in clients) {
                    clients[client].forEach((sources) => {
                        let nodeButton = document.createElement("button");
                        nodeButton.setAttribute('data', sources.url + ' ' + client);
                        nodeButton.appendChild(document.createTextNode(sources.description));
                        nodeButton.onclick = (event) => {
                            setPlayerSource(event.target.getAttribute('data'));
                        };
                        sourcesNode.appendChild(nodeButton);
                    });
                }
            };

            var link = document.createElement('a');
            let dataHandler = function (data, prefix) {
                let blob = new Blob([data], { type: "application/mp4" });
                link.href = window.URL.createObjectURL(blob);
                link.download = `${prefix}_${formatDate(new Date())}.mp4`;
                link.click();
            }

            let formatHandler = function (format) {
                if (html5Player && html5Canvas) {
                    if (format === 'h265') {
                        html5Player.setAttribute('hidden', true);
                        html5Canvas.removeAttribute('hidden');
                    } else if (format === 'h264') {
                        html5Player.removeAttribute('hidden');
                        html5Canvas.setAttribute('hidden', true);
                    }
                }
            }

            function formatDate(dateObj) {
                let month = String(dateObj.getMonth() + 1).padStart(2, '0');
                let date = String(dateObj.getDate()).padStart(2, '0');
                let hours = String(dateObj.getHours()).padStart(2, '0');
                let minutes = String(dateObj.getMinutes()).padStart(2, '0');
                let seconds = String(dateObj.getSeconds()).padStart(2, '0');
                return `${dateObj.getFullYear()}-${month}-${date} ${hours}:${minutes}:${seconds}`;
            }

            var playerOptions = {
                socket: "ws://localhost:8088/ws/",
                redirectNativeMediaErrors: true,
                bufferDuration: 30,
                errorHandler: errHandler,
                infoHandler: infHandler,
                dataHandler: dataHandler,
                videoFormatHandler: formatHandler,
                continuousFileLength: 180000,
                eventFileLength: 10000,
                canvas: 'video_canvas',
            };

            var html5Player = document.getElementById("test_video");
            var html5Canvas = document.getElementById("video_canvas");
            var urlButton = document.getElementById("set_new_url");
            var urlEdit = document.getElementById("stream_url");
            var bufferRange = document.getElementById("buffer_duration");
            var bufferValue = document.getElementById("buffer_value");
            var continuousRecording = document.getElementById("continuous_recording");
            var eventRecording = document.getElementById("event_recording");
            var continuousFileLength = document.getElementById("continuous_file_length");
            var continuousFileLengthLabel = document.getElementById("continuous_file_length_label");
            var eventFileLength = document.getElementById("event_file_length");
            var eventFileLengthLabel = document.getElementById("event_file_length_label");

            var player = Streamedian.player('test_video', playerOptions);
            var nativePlayer = document.getElementById('test_video');
            var range = document.getElementById('rate');
            var set_live = document.getElementById('to_end');
            var range_out = document.getElementById('rate_res');

            var socket;
            var keepAliveTimer;
            var password = btoa('streamedian');

            range.addEventListener('input', function () {
                nativePlayer.playbackRate = range.value;
                range_out.innerHTML = `x${range.value}`;
            });
            set_live.addEventListener('click', function () {
                range.value = 1.0;
                range_out.innerHTML = `live`;
                nativePlayer.playbackRate = 1;
                nativePlayer.currentTime = nativePlayer.buffered.end(0);
            });

            // Tab switching and window minimization processing 
            // for browsers that use the chrome rendering engine.
            if (!!window.chrome) {
                document.addEventListener('visibilitychange', function () {
                    if (document.visibilityState === 'hidden') {
                        nativePlayer.pause()
                    } else {
                        nativePlayer.play();

                        // Automatic jump to buffer end for view live video when returning to the web page. 
                        setTimeout(function () {
                            nativePlayer.currentTime = nativePlayer.buffered.end(0)
                        }, 3000); // Delay for a few seconds is required for the player has time to update the timeline.
                    }
                });
            }

            var updateRangeControls = function () {
                bufferRange.value = player.bufferDuration;
                bufferValue.innerHTML = bufferRange.value + "sec.";

                continuousFileLength.value = player.continuousRecording.fileLength;
                continuousFileLengthLabel.innerText = `${continuousFileLength.value / 1000} sec.`;

                eventFileLength.value = player.eventRecording.fileLength;
                event_file_length_label.innerText = `${eventFileLength.value / 1000} sec.`;
            };

            bufferRange.addEventListener('input', function () {
                var iValue = parseInt(this.value, 10);
                player.bufferDuration = iValue;
                bufferValue.innerHTML = this.value + "sec.";
            });

            bufferRange.innerHTML = player.bufferDuration + "sec.";
            updateRangeControls();

            continuousRecording.addEventListener('change', function (event) {
                player.continuousRecording.record(event.target.checked);
                continuousFileLength.disabled = event.target.checked;
            });

            eventRecording.addEventListener('click', function (event) {
                let state = !event.target.classList.contains('btn-recording');
                player.eventRecording.record(state);
                event.target.classList.toggle('btn-success');
                event.target.classList.toggle('btn-recording');
                event.target.innerText = state ? 'Stop recording' : 'Start recording';
                eventFileLength.disabled = state;
            });

            continuousFileLength.addEventListener('input', function (event) {
                let milliseconds = parseInt(event.target.value, 10);
                player.continuousRecording.fileLength = milliseconds;
                continuousFileLengthLabel.innerText = `${milliseconds / 1000} sec.`;
            });

            eventFileLength.addEventListener('input', function (event) {
                let milliseconds = parseInt(event.target.value, 10);
                player.eventRecording.fileLength = milliseconds;
                eventFileLengthLabel.innerText = `${milliseconds / 1000} sec.`;
            });

            urlButton.onclick = () => {
                setPlayerSource(urlEdit.value);
            };

            function setPlayerSource(newSource) {
                player.destroy();
                player = null;
                html5Player.src = newSource;
                player = Streamedian.player("test_video", playerOptions);
                player.continuousRecording.record(continuousRecording.checked);
                updateRangeControls();

                eventRecording.removeAttribute('disabled');
                set_live.removeAttribute('disabled');
            }

            file_input.addEventListener('change', function (event) {
                html5Player.src = URL.createObjectURL(event.target.files[0]);
            });

            window.addEventListener('unload', function () {
                player.continuousRecording.record(false);
                player.eventRecording.record(false);
            });

            function statisticRequest(cmd) {
                if (socket == undefined || socket.readyState != 1) {
                    socket = new WebSocket(playerOptions.socket, "statistic");
                    socket.onmessage = onStatistic;
                    socket.onopen = function () {
                        socket.send(`WSP/1.1 ${cmd}\nAuthorization: ${password}\nseq: 1\n\n`);

                        keepAliveTimer = setInterval(() => {
                            socket.send(`WSP/1.1 KEEPALIVE\nAuthorization: ${password}\nseq: 1\n\n`);
                        }, 30000); // Every 30 seconds
                    }

                    socket.onclose = function () {
                        clearInterval(keepAliveTimer);
                    }
                } else {
                    socket.send(`WSP/1.1 ${cmd}\nAuthorization: ${password}\nseq: 1\n\n`);
                }
            }

            function onStatistic(msg) {
                if (msg.data.length) {
                    let data = msg.data.split('\r\n\r\n');

                    if (data.length > 1) {
                        parseStatistic(JSON.parse(data[1]));
                    } else {
                        console.log("------------- Info -------------");
                        parseSession(JSON.parse(data[0]));
                    }

                }
            };

            function parseSession(session) {
                console.log(`Requested domain: ${session.user.requestedDomain}`);
                console.log(`User address: ${session.user.address}`);
                console.log(`RTSP address: ${session.rtsp.host}:${session.rtsp.port}`);
                console.log(`Session start time: ${new Date(Number(session.connectionTime + '000'))}`);

                if (session.disconnectionTime) {
                    console.log(`Session end time: ${new Date(Number(session.disconnectionTime + '000'))}`);
                }

                console.log('---');
            }

            function parseStatistic(data) {
                for (let i = 0; i < data.licenses.length; i++) {
                    let license = data.licenses[i].license;
                    let sessions = data.licenses[i].sessions;
                    let sessionNumber = data.licenses[i].sessionNumber;

                    console.log("------------- Info -------------");
                    console.log('              License ' + i);
                    console.log(`Activation Key: ${license.key}`)
                    console.log(`Expires: ${license.expiresAt}`);
                    console.log(`License max posible watchers: ${license.maxWatchers}`);

                    if (license.maxWatchers !== 'unlimited') {
                        console.log(`Remain watchers: ${license.maxWatchers - sessionNumber}`);
                    }

                    console.log('Sessions:');
                    for (let j = 0; j < sessions.length; j++) {
                        parseSession(sessions[j]);
                    }
                }
            }

            function getStatistic() {
                statisticRequest('GET_INFO', password);
                socket.onmessage = statisticInfoParse;
            }

            function subscribeStatistic() {
                statisticRequest('SUBSCRIBE', password);
            }
        }
    </script>

    <script>
        layui.use(['form', 'laydate', 'util'], function () {
            var form = layui.form;
            var layer = layui.layer;
            var laydate = layui.laydate;
            var util = layui.util;

            // 提交事件
            form.on('submit(submit)', function (data) {
                var field = data.field; // 获取表单字段值
                // 显示填写结果，仅作演示用
                layer.alert(JSON.stringify(field), {
                    title: '当前填写的字段值'
                });
                // 此处可执行 Ajax 等操作--发送到后端,试试能否直接发送到AI端--可以直接发到AI端
                // fetch("http://127.0.0.1:9003/image/objectDetect", {
                //     method: "POST",
                //     headers: {
                //         'Content-Type': 'application/json'
                //     },
                //     body: JSON.stringify({ "scoreTh": data.scoreTh, "iouTh": data.iouTh })
                // })
                //     .then(response => response.json())
                //     .then(ret => {
                //         if (ret.code === 1000) {
                //             layer.alert(ret.msg);
                //         } else {
                //             layer.alert(ret.msg);
                //         }
                //     })
                //     .catch(error => {
                //         layer.alert(error, { title: '意外错误' });
                //     });
                return false; // 阻止默认 form 跳转
            });
        });
    </script>

</body>

</html>